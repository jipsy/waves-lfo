<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WavesJS - Low Frequency Operators - Source: node/source/AudioInFile.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles/overrides.css">
</head>

<body>

<div id="main">

    <!-- if home page assume a title is already present in README -->
    
    <h1 class="page-title">Source: node/source/AudioInFile.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import BaseLfo from '../../common/core/BaseLfo';
import av from 'av';


const definitions = {
  filename: {
    type: 'string',
    default: null,
    constant: true,
  },
  frameSize: {
    type: 'integer',
    default: 512,
    constant: true,
  },
  channel: {
    type: 'integer',
    default: 0,
    constant: true,
  },
};

/**
 * Read a file and propagate raw signal into the graph.
 *
 * This node is based on the
 * [`aurora.js`](https://github.com/audiocogs/aurora.js) library.
 *
 * @param {Object} options - Override default options.
 * @param {String} [options.filename=null] - Path to the file.
 * @param {Number} [options.frameSize=512] - Size of output frame.
 * @param {Number} [options.channel=0] - Channel number of the input file.
 *
 * @todo - define which channel should be loaded.
 *
 * @memberof module:node.source
 *
 * @example
 * import * as lfo from 'waves-lfo/node';
 * import path from 'path';
 *
 * const filename = path.join(process.cwd(), './my-file');
 *
 * const audioInFile = new AudioInFile({
 *   filename: filename,
 *   frameSize: 512,
 * });
 *
 * const logger = new Logger({
 *   data: true,
 * });
 *
 * audioInFile.connect(logger);
 * audioInFile.start();
 */
class AudioInFile extends BaseLfo {
  constructor(options) {
    super(definitions, options);

    this.processStreamParams = this.processStreamParams.bind(this);
  }

  /**
   * Start the graph, load the file and start slicing it.
   *
   * @see {@link module:common.core.BaseLfo#processStreamParams}
   * @see {@link module:common.core.BaseLfo#resetStream}
   * @see {@link module:node.source.AudioInFile#stop}
   */
  start() {
    const filename = this.params.get('filename');
    this.asset = av.Asset.fromFile(filename);
    this.asset.on('error', (err) => console.log(err.stack));
    // call `processStreamParams` because sampleRate is only available
    this.asset.decodeToBuffer((buffer) => {
      this.initStream();
      this.processFrame(buffer);
    });
  }

  /**
   * Finalize the stream and stop the graph.
   *
   * @see {@link module:common.core.BaseLfo#finalizeStream}
   * @see {@link module:node.source.AudioInFile#start}
   */
  stop() {
    this.finalizeStream(this.endTime);
  }

  /** @private */
  processStreamParams() {
    const frameSize = this.params.get('frameSize');
    const channel = this.params.get('channel');
    const sourceSampleRate = this.asset.format.sampleRate;
    const channelsPerFrame = this.asset.format.channelsPerFrame;

    if (channel >= channelsPerFrame)
      throw new Error('Invalid channel number, given file only contains ${channelsPerFrame} channels');

    this.streamParams.frameType = 'signal';
    this.streamParams.frameSize = frameSize;
    this.streamParams.sourceSampleRate = sourceSampleRate;
    this.streamParams.frameRate = sourceSampleRate / frameSize;
    this.streamParams.sourceSampleCount = frameSize;

    this.channelsPerFrame = channelsPerFrame;

    this.propagateStreamParams();
  }

  /** @private */
  processFrame(buffer) {
    const frameSize = this.params.get('frameSize');
    const channel = this.params.get('channel');
    const sampleRate = this.streamParams.sourceSampleRate;
    const channelsPerFrame = this.channelsPerFrame;
    const length = buffer.length;
    const sourceFrameSize = frameSize * channelsPerFrame;
    const nbrFrames = Math.ceil(length / sourceFrameSize);
    const frameDuration = frameSize / sampleRate;
    const endTime = length / (channelsPerFrame * sampleRate);
    const data = this.frame.data;

    let sourceIndex = 0;

    // input buffer is interleaved, pick only values according to `channel`
    for (let frameIndex = 0; frameIndex &lt; nbrFrames; frameIndex++) {
      for (let i = 0; i &lt; frameSize; i++) {
        const index = sourceIndex + channel;
        data[i] = sourceIndex &lt; length ? buffer[index] : 0;

        sourceIndex += channelsPerFrame;
      }

      this.frame.time = frameIndex * frameDuration;
      this.endTime = Math.min(this.frame.time + frameDuration, endTime);

      this.propagateFrame();
    }

    this.finalizeStream(this.endTime);
  }
}

export default AudioInFile;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-client.sink.BaseDisplay.html">client.sink.BaseDisplay</a></li><li><a href="module-client.sink.BpfDisplay.html">client.sink.BpfDisplay</a></li><li><a href="module-client.sink.MarkerDisplay.html">client.sink.MarkerDisplay</a></li><li><a href="module-client.sink.SignalDisplay.html">client.sink.SignalDisplay</a></li><li><a href="module-client.sink.SpectrumDisplay.html">client.sink.SpectrumDisplay</a></li><li><a href="module-client.sink.TraceDisplay.html">client.sink.TraceDisplay</a></li><li><a href="module-client.sink.VuMeterDisplay.html">client.sink.VuMeterDisplay</a></li><li><a href="module-client.sink.WaveformDisplay.html">client.sink.WaveformDisplay</a></li><li><a href="module-client.source.AudioInBuffer.html">client.source.AudioInBuffer</a></li><li><a href="module-client.source.AudioInNode.html">client.source.AudioInNode</a></li><li><a href="module-common.core.BaseLfo.html">common.core.BaseLfo</a></li><li><a href="module-common.operator.Biquad.html">common.operator.Biquad</a></li><li><a href="module-common.operator.Dct.html">common.operator.Dct</a></li><li><a href="module-common.operator.Fft.html">common.operator.Fft</a></li><li><a href="module-common.operator.Magnitude.html">common.operator.Magnitude</a></li><li><a href="module-common.operator.MeanStddev.html">common.operator.MeanStddev</a></li><li><a href="module-common.operator.Mel.html">common.operator.Mel</a></li><li><a href="module-common.operator.Mfcc.html">common.operator.Mfcc</a></li><li><a href="module-common.operator.MinMax.html">common.operator.MinMax</a></li><li><a href="module-common.operator.MovingAverage.html">common.operator.MovingAverage</a></li><li><a href="module-common.operator.MovingMedian.html">common.operator.MovingMedian</a></li><li><a href="module-common.operator.OnOff.html">common.operator.OnOff</a></li><li><a href="module-common.operator.Rms.html">common.operator.Rms</a></li><li><a href="module-common.operator.Segmenter.html">common.operator.Segmenter</a></li><li><a href="module-common.operator.Select.html">common.operator.Select</a></li><li><a href="module-common.operator.Slicer.html">common.operator.Slicer</a></li><li><a href="module-common.operator.Yin.html">common.operator.Yin</a></li><li><a href="module-common.sink.Bridge.html">common.sink.Bridge</a></li><li><a href="module-common.sink.DataRecorder.html">common.sink.DataRecorder</a></li><li><a href="module-common.sink.Logger.html">common.sink.Logger</a></li><li><a href="module-common.sink.SignalRecorder.html">common.sink.SignalRecorder</a></li><li><a href="module-common.source.EventIn.html">common.source.EventIn</a></li><li><a href="module-node.sink.DataToFile.html">node.sink.DataToFile</a></li><li><a href="module-node.source.AudioInFile.html">node.source.AudioInFile</a></li></ul>
</nav>

<br class="clear">

<footer>
    
        Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.2</a> on Thu Oct 27 2016 12:02:43 GMT+0200 (CEST)
    
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
