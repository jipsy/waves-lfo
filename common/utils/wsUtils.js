'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.decoders = exports.encoders = exports.opcodes = undefined;

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

//http://stackoverflow.com/questions/8609289/convert-a-binary-nodejs-buffer-to-javascript-arraybuffer
// converts a nodejs Buffer to ArrayBuffer
// export function bufferToArrayBuffer(buffer) {
//   const ab = new ArrayBuffer(buffer.length);
//   const view = new Uint8Array(ab);

//   for (let i = 0; i < buffer.length; ++i)
//     view[i] = buffer[i];

//   return ab;
// }

// export function arrayBufferToBuffer(arrayBuffer) {
//   const buffer = new Buffer(arrayBuffer.byteLength);
//   const view = new Uint8Array(arrayBuffer);

//   for (let i = 0; i < buffer.length; ++i)
//     buffer[i] = view[i];

//   return buffer;
// }

// http://updates.html5rocks.com/2012/06/How-to-convert-ArrayBuffer-to-and-from-String
function Uint16Array2json(arr) {
  var str = String.fromCharCode.apply(null, arr);
  return JSON.parse(str.replace(/\u0000/g, ''));
}

function json2Uint16Array(json) {
  var str = (0, _stringify2.default)(json);
  var buffer = new ArrayBuffer(str.length * 2); // 2 bytes for each char
  var bufferView = new Uint16Array(buffer);

  for (var i = 0, l = str.length; i < l; i++) {
    bufferView[i] = str.charCodeAt(i);
  }return bufferView;
}

var opcodes = exports.opcodes = {
  INIT_MODULE_REQ: 10,
  INIT_MODULE_ACK: 11,
  PROCESS_STREAM_PARAMS: 12,
  RESET_STREAM: 13,
  FINALIZE_STREAM: 14,
  PROCESS_FRAME: 15
};

//
var encoders = exports.encoders = {
  opcode: function opcode(name) {
    var opcode = opcodes[name];
    var buffer = new Uint16Array(1);
    buffer[0] = opcode;

    return buffer;
  },

  // `opcode`    2 bytes (Uint16) |
  initModuleReq: function initModuleReq() {
    var payload = encoders.opcode('INIT_MODULE_REQ');
    return payload.buffer;
  },
  // `opcode`    2 bytes (Uint16) |
  initModuleAck: function initModuleAck() {
    var payload = encoders.opcode('INIT_MODULE_ACK');
    return payload.buffer;
  },
  // `opcode`    2 bytes (Uint16) |
  // `streamParams`  n bytes (Uint16)
  streamParams: function streamParams(_streamParams) {
    var opcode = encoders.opcode('PROCESS_STREAM_PARAMS');
    var streamParamsBuffer = json2Uint16Array(_streamParams);

    var payload = new Uint16Array(1 + streamParamsBuffer.length);
    payload.set(opcode, 0);
    payload.set(streamParamsBuffer, 1);

    return payload.buffer;
  },
  // `opcode`    2 bytes (Uint16) |
  resetStream: function resetStream() {
    var payload = encoders.opcode('RESET_STREAM');
    return payload.buffer;
  },
  // `opcode`    2 bytes (Uint16) |
  // `endTime`   8 bytes (Float64)
  finalizeStream: function finalizeStream(endTime) {
    var opcode = encoders.opcode('RESET_STREAM');

    var endTimeBuffer = new Float64Array(1);
    endTimeBuffer[0] = endTime;

    var payload = new Uint16Array(1 + 4);
    payload.set(opcode, 0);
    payload.set(new Uint16Array(endTimeBuffer.buffer), 1);

    return payload.buffer;
  },
  // `opcode`    2 bytes (Uint16) |
  // `time`      8 bytes (Float64) |
  // `data`      frameSize * 4 (Float32) |
  // `metadata`  n bytes (Uint16)
  processFrame: function processFrame(frame, frameSize) {
    var opcode = encoders.opcode('PROCESS_FRAME');

    var time = new Float64Array(1);
    time[0] = frame.time;

    var data = new Float32Array(frameSize);
    for (var i = 0; i < frameSize; i++) {
      data[i] = frame.data[i];
    }var metadata = json2Uint16Array(frame.metadata);

    var length = 1 + 4 + 2 * frameSize + metadata.length;
    var payload = new Uint16Array(length);
    payload.set(opcode, 0);
    payload.set(new Uint16Array(time.buffer), 1);
    payload.set(new Uint16Array(data.buffer), 1 + 4);
    payload.set(metadata, 1 + 4 + 2 * frameSize);

    return payload.buffer;
  }
};

var decoders = exports.decoders = {
  opcode: function opcode(arrayBuffer) {
    return new Uint16Array(arrayBuffer)[0];
  },

  // `opcode`    2 bytes (Uint16) |
  // `streamParams`  n bytes (Uint16)
  streamParams: function streamParams(arrayBuffer) {
    var payload = new Uint16Array(arrayBuffer.slice(2));
    var prevStreamParams = Uint16Array2json(payload);
    return prevStreamParams;
  },

  // `opcode`    2 bytes (Uint16) |
  // `endTime`   8 bytes (Float64)
  finalizeStream: function finalizeStream(arrayBuffer) {
    return new Float64Array(arrayBuffer.slice(2))[0];
  },

  // `opcode`    2 bytes (Uint16) |
  // `time`      8 bytes (Float64) |
  // `data`      frameSize * 4 (Float32) |
  // `metadata`  n bytes (Uint16)
  processFrame: function processFrame(arrayBuffer, frameSize) {
    // 1 * 8 bytes
    var timeStart = 2;
    var timeEnd = timeStart + 8;
    var time = new Float64Array(arrayBuffer.slice(timeStart, timeEnd))[0];
    // frameSize * 4 bytes
    var dataStart = timeEnd;
    var dataEnd = dataStart + 4 * frameSize;
    var data = new Float32Array(arrayBuffer.slice(dataStart, dataEnd));
    // rest of payload
    var metaStart = dataEnd;
    var metaBuffer = new Uint16Array(arrayBuffer.slice(metaStart));
    var metadata = Uint16Array2json(metaBuffer);

    return { time: time, data: data, metadata: metadata };
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndzVXRpbHMuanMiXSwibmFtZXMiOlsiVWludDE2QXJyYXkyanNvbiIsImFyciIsInN0ciIsIlN0cmluZyIsImZyb21DaGFyQ29kZSIsImFwcGx5IiwiSlNPTiIsInBhcnNlIiwicmVwbGFjZSIsImpzb24yVWludDE2QXJyYXkiLCJqc29uIiwiYnVmZmVyIiwiQXJyYXlCdWZmZXIiLCJsZW5ndGgiLCJidWZmZXJWaWV3IiwiVWludDE2QXJyYXkiLCJpIiwibCIsImNoYXJDb2RlQXQiLCJvcGNvZGVzIiwiSU5JVF9NT0RVTEVfUkVRIiwiSU5JVF9NT0RVTEVfQUNLIiwiUFJPQ0VTU19TVFJFQU1fUEFSQU1TIiwiUkVTRVRfU1RSRUFNIiwiRklOQUxJWkVfU1RSRUFNIiwiUFJPQ0VTU19GUkFNRSIsImVuY29kZXJzIiwib3Bjb2RlIiwibmFtZSIsImluaXRNb2R1bGVSZXEiLCJwYXlsb2FkIiwiaW5pdE1vZHVsZUFjayIsInN0cmVhbVBhcmFtcyIsInN0cmVhbVBhcmFtc0J1ZmZlciIsInNldCIsInJlc2V0U3RyZWFtIiwiZmluYWxpemVTdHJlYW0iLCJlbmRUaW1lIiwiZW5kVGltZUJ1ZmZlciIsIkZsb2F0NjRBcnJheSIsInByb2Nlc3NGcmFtZSIsImZyYW1lIiwiZnJhbWVTaXplIiwidGltZSIsImRhdGEiLCJGbG9hdDMyQXJyYXkiLCJtZXRhZGF0YSIsImRlY29kZXJzIiwiYXJyYXlCdWZmZXIiLCJzbGljZSIsInByZXZTdHJlYW1QYXJhbXMiLCJ0aW1lU3RhcnQiLCJ0aW1lRW5kIiwiZGF0YVN0YXJ0IiwiZGF0YUVuZCIsIm1ldGFTdGFydCIsIm1ldGFCdWZmZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0EsU0FBU0EsZ0JBQVQsQ0FBMEJDLEdBQTFCLEVBQStCO0FBQzdCLE1B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LGtCQUFkLEVBQVA7QUFDSDtBQW5DcUIsQ0FBakIiLCJmaWxlIjoid3NVdGlscy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy84NjA5Mjg5L2NvbnZlcnQtYS1iaW5hcnktbm9kZWpzLWJ1ZmZlci10by1qYXZhc2NyaXB0LWFycmF5YnVmZmVyXG4vLyBjb252ZXJ0cyBhIG5vZGVqcyBCdWZmZXIgdG8gQXJyYXlCdWZmZXJcbi8vIGV4cG9ydCBmdW5jdGlvbiBidWZmZXJUb0FycmF5QnVmZmVyKGJ1ZmZlcikge1xuLy8gICBjb25zdCBhYiA9IG5ldyBBcnJheUJ1ZmZlcihidWZmZXIubGVuZ3RoKTtcbi8vICAgY29uc3QgdmlldyA9IG5ldyBVaW50OEFycmF5KGFiKTtcblxuLy8gICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlci5sZW5ndGg7ICsraSlcbi8vICAgICB2aWV3W2ldID0gYnVmZmVyW2ldO1xuXG4vLyAgIHJldHVybiBhYjtcbi8vIH1cblxuLy8gZXhwb3J0IGZ1bmN0aW9uIGFycmF5QnVmZmVyVG9CdWZmZXIoYXJyYXlCdWZmZXIpIHtcbi8vICAgY29uc3QgYnVmZmVyID0gbmV3IEJ1ZmZlcihhcnJheUJ1ZmZlci5ieXRlTGVuZ3RoKTtcbi8vICAgY29uc3QgdmlldyA9IG5ldyBVaW50OEFycmF5KGFycmF5QnVmZmVyKTtcblxuLy8gICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlci5sZW5ndGg7ICsraSlcbi8vICAgICBidWZmZXJbaV0gPSB2aWV3W2ldO1xuXG4vLyAgIHJldHVybiBidWZmZXI7XG4vLyB9XG5cbi8vIGh0dHA6Ly91cGRhdGVzLmh0bWw1cm9ja3MuY29tLzIwMTIvMDYvSG93LXRvLWNvbnZlcnQtQXJyYXlCdWZmZXItdG8tYW5kLWZyb20tU3RyaW5nXG5mdW5jdGlvbiBVaW50MTZBcnJheTJqc29uKGFycikge1xuICBjb25zdCBzdHIgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGFycik7XG4gIHJldHVybiBKU09OLnBhcnNlKHN0ci5yZXBsYWNlKC9cXHUwMDAwL2csICcnKSlcbn1cblxuZnVuY3Rpb24ganNvbjJVaW50MTZBcnJheShqc29uKSB7XG4gIGNvbnN0IHN0ciA9IEpTT04uc3RyaW5naWZ5KGpzb24pO1xuICBjb25zdCBidWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoc3RyLmxlbmd0aCAqIDIpOyAvLyAyIGJ5dGVzIGZvciBlYWNoIGNoYXJcbiAgY29uc3QgYnVmZmVyVmlldyA9IG5ldyBVaW50MTZBcnJheShidWZmZXIpO1xuXG4gIGZvciAobGV0IGkgPSAwLCBsID0gc3RyLmxlbmd0aDsgaSA8IGw7IGkrKylcbiAgICBidWZmZXJWaWV3W2ldID0gc3RyLmNoYXJDb2RlQXQoaSk7XG5cbiAgcmV0dXJuIGJ1ZmZlclZpZXc7XG59XG5cblxuZXhwb3J0IGNvbnN0IG9wY29kZXMgPSB7XG4gIElOSVRfTU9EVUxFX1JFUTogMTAsXG4gIElOSVRfTU9EVUxFX0FDSzogMTEsXG4gIFBST0NFU1NfU1RSRUFNX1BBUkFNUzogMTIsXG4gIFJFU0VUX1NUUkVBTTogMTMsXG4gIEZJTkFMSVpFX1NUUkVBTTogMTQsXG4gIFBST0NFU1NfRlJBTUU6IDE1XG59XG5cbi8vXG5leHBvcnQgY29uc3QgZW5jb2RlcnMgPSB7XG4gIG9wY29kZShuYW1lKSB7XG4gICAgY29uc3Qgb3Bjb2RlID0gb3Bjb2Rlc1tuYW1lXTtcbiAgICBjb25zdCBidWZmZXIgPSBuZXcgVWludDE2QXJyYXkoMSk7XG4gICAgYnVmZmVyWzBdID0gb3Bjb2RlO1xuXG4gICAgcmV0dXJuIGJ1ZmZlcjtcbiAgfSxcbiAgLy8gYG9wY29kZWAgICAgMiBieXRlcyAoVWludDE2KSB8XG4gIGluaXRNb2R1bGVSZXE6IGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IHBheWxvYWQgPSBlbmNvZGVycy5vcGNvZGUoJ0lOSVRfTU9EVUxFX1JFUScpO1xuICAgIHJldHVybiBwYXlsb2FkLmJ1ZmZlcjtcbiAgfSxcbiAgLy8gYG9wY29kZWAgICAgMiBieXRlcyAoVWludDE2KSB8XG4gIGluaXRNb2R1bGVBY2s6IGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IHBheWxvYWQgPSBlbmNvZGVycy5vcGNvZGUoJ0lOSVRfTU9EVUxFX0FDSycpO1xuICAgIHJldHVybiBwYXlsb2FkLmJ1ZmZlcjtcbiAgfSxcbiAgLy8gYG9wY29kZWAgICAgMiBieXRlcyAoVWludDE2KSB8XG4gIC8vIGBzdHJlYW1QYXJhbXNgICBuIGJ5dGVzIChVaW50MTYpXG4gIHN0cmVhbVBhcmFtczogZnVuY3Rpb24oc3RyZWFtUGFyYW1zKSB7XG4gICAgY29uc3Qgb3Bjb2RlID0gZW5jb2RlcnMub3Bjb2RlKCdQUk9DRVNTX1NUUkVBTV9QQVJBTVMnKTtcbiAgICBjb25zdCBzdHJlYW1QYXJhbXNCdWZmZXIgPSBqc29uMlVpbnQxNkFycmF5KHN0cmVhbVBhcmFtcyk7XG5cbiAgICBjb25zdCBwYXlsb2FkID0gbmV3IFVpbnQxNkFycmF5KDEgKyBzdHJlYW1QYXJhbXNCdWZmZXIubGVuZ3RoKTtcbiAgICBwYXlsb2FkLnNldChvcGNvZGUsIDApO1xuICAgIHBheWxvYWQuc2V0KHN0cmVhbVBhcmFtc0J1ZmZlciwgMSk7XG5cbiAgICByZXR1cm4gcGF5bG9hZC5idWZmZXI7XG4gIH0sXG4gIC8vIGBvcGNvZGVgICAgIDIgYnl0ZXMgKFVpbnQxNikgfFxuICByZXNldFN0cmVhbTogZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgcGF5bG9hZCA9IGVuY29kZXJzLm9wY29kZSgnUkVTRVRfU1RSRUFNJyk7XG4gICAgcmV0dXJuIHBheWxvYWQuYnVmZmVyO1xuICB9LFxuICAvLyBgb3Bjb2RlYCAgICAyIGJ5dGVzIChVaW50MTYpIHxcbiAgLy8gYGVuZFRpbWVgICAgOCBieXRlcyAoRmxvYXQ2NClcbiAgZmluYWxpemVTdHJlYW06IGZ1bmN0aW9uKGVuZFRpbWUpIHtcbiAgICBjb25zdCBvcGNvZGUgPSBlbmNvZGVycy5vcGNvZGUoJ1JFU0VUX1NUUkVBTScpO1xuXG4gICAgY29uc3QgZW5kVGltZUJ1ZmZlciA9IG5ldyBGbG9hdDY0QXJyYXkoMSk7XG4gICAgZW5kVGltZUJ1ZmZlclswXSA9IGVuZFRpbWU7XG5cbiAgICBjb25zdCBwYXlsb2FkID0gbmV3IFVpbnQxNkFycmF5KDEgKyA0KTtcbiAgICBwYXlsb2FkLnNldChvcGNvZGUsIDApO1xuICAgIHBheWxvYWQuc2V0KG5ldyBVaW50MTZBcnJheShlbmRUaW1lQnVmZmVyLmJ1ZmZlciksIDEpO1xuXG4gICAgcmV0dXJuIHBheWxvYWQuYnVmZmVyO1xuICB9LFxuICAvLyBgb3Bjb2RlYCAgICAyIGJ5dGVzIChVaW50MTYpIHxcbiAgLy8gYHRpbWVgICAgICAgOCBieXRlcyAoRmxvYXQ2NCkgfFxuICAvLyBgZGF0YWAgICAgICBmcmFtZVNpemUgKiA0IChGbG9hdDMyKSB8XG4gIC8vIGBtZXRhZGF0YWAgIG4gYnl0ZXMgKFVpbnQxNilcbiAgcHJvY2Vzc0ZyYW1lOiBmdW5jdGlvbihmcmFtZSwgZnJhbWVTaXplKSB7XG4gICAgY29uc3Qgb3Bjb2RlID0gZW5jb2RlcnMub3Bjb2RlKCdQUk9DRVNTX0ZSQU1FJyk7XG5cbiAgICBjb25zdCB0aW1lID0gbmV3IEZsb2F0NjRBcnJheSgxKTtcbiAgICB0aW1lWzBdID0gZnJhbWUudGltZTtcblxuICAgIGNvbnN0IGRhdGEgPSBuZXcgRmxvYXQzMkFycmF5KGZyYW1lU2l6ZSk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmcmFtZVNpemU7IGkrKylcbiAgICAgIGRhdGFbaV0gPSBmcmFtZS5kYXRhW2ldO1xuXG4gICAgY29uc3QgbWV0YWRhdGEgPSBqc29uMlVpbnQxNkFycmF5KGZyYW1lLm1ldGFkYXRhKTtcblxuICAgIGNvbnN0IGxlbmd0aCA9IDEgKyA0ICsgKDIgKiBmcmFtZVNpemUpICsgbWV0YWRhdGEubGVuZ3RoO1xuICAgIGNvbnN0IHBheWxvYWQgPSBuZXcgVWludDE2QXJyYXkobGVuZ3RoKTtcbiAgICBwYXlsb2FkLnNldChvcGNvZGUsIDApO1xuICAgIHBheWxvYWQuc2V0KG5ldyBVaW50MTZBcnJheSh0aW1lLmJ1ZmZlciksIDEpO1xuICAgIHBheWxvYWQuc2V0KG5ldyBVaW50MTZBcnJheShkYXRhLmJ1ZmZlciksIDEgKyA0KTtcbiAgICBwYXlsb2FkLnNldChtZXRhZGF0YSwgMSArIDQgKyAoMiAqIGZyYW1lU2l6ZSkpO1xuXG4gICAgcmV0dXJuIHBheWxvYWQuYnVmZmVyO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBkZWNvZGVycyA9IHtcbiAgb3Bjb2RlKGFycmF5QnVmZmVyKSB7XG4gICAgcmV0dXJuIG5ldyBVaW50MTZBcnJheShhcnJheUJ1ZmZlcilbMF07XG4gIH0sXG4gIC8vIGBvcGNvZGVgICAgIDIgYnl0ZXMgKFVpbnQxNikgfFxuICAvLyBgc3RyZWFtUGFyYW1zYCAgbiBieXRlcyAoVWludDE2KVxuICBzdHJlYW1QYXJhbXMoYXJyYXlCdWZmZXIpIHtcbiAgICBjb25zdCBwYXlsb2FkID0gbmV3IFVpbnQxNkFycmF5KGFycmF5QnVmZmVyLnNsaWNlKDIpKTtcbiAgICBjb25zdCBwcmV2U3RyZWFtUGFyYW1zID0gVWludDE2QXJyYXkyanNvbihwYXlsb2FkKTtcbiAgICByZXR1cm4gcHJldlN0cmVhbVBhcmFtcztcbiAgfSxcbiAgLy8gYG9wY29kZWAgICAgMiBieXRlcyAoVWludDE2KSB8XG4gIC8vIGBlbmRUaW1lYCAgIDggYnl0ZXMgKEZsb2F0NjQpXG4gIGZpbmFsaXplU3RyZWFtKGFycmF5QnVmZmVyKSB7XG4gICAgcmV0dXJuIG5ldyBGbG9hdDY0QXJyYXkoYXJyYXlCdWZmZXIuc2xpY2UoMikpWzBdO1xuICB9LFxuICAvLyBgb3Bjb2RlYCAgICAyIGJ5dGVzIChVaW50MTYpIHxcbiAgLy8gYHRpbWVgICAgICAgOCBieXRlcyAoRmxvYXQ2NCkgfFxuICAvLyBgZGF0YWAgICAgICBmcmFtZVNpemUgKiA0IChGbG9hdDMyKSB8XG4gIC8vIGBtZXRhZGF0YWAgIG4gYnl0ZXMgKFVpbnQxNilcbiAgcHJvY2Vzc0ZyYW1lKGFycmF5QnVmZmVyLCBmcmFtZVNpemUpIHtcbiAgICAgIC8vIDEgKiA4IGJ5dGVzXG4gICAgICBjb25zdCB0aW1lU3RhcnQgPSAyO1xuICAgICAgY29uc3QgdGltZUVuZCA9IHRpbWVTdGFydCArIDg7XG4gICAgICBjb25zdCB0aW1lID0gbmV3IEZsb2F0NjRBcnJheShhcnJheUJ1ZmZlci5zbGljZSh0aW1lU3RhcnQsIHRpbWVFbmQpKVswXTtcbiAgICAgIC8vIGZyYW1lU2l6ZSAqIDQgYnl0ZXNcbiAgICAgIGNvbnN0IGRhdGFTdGFydCA9IHRpbWVFbmQ7XG4gICAgICBjb25zdCBkYXRhRW5kID0gZGF0YVN0YXJ0ICsgNCAqIGZyYW1lU2l6ZTtcbiAgICAgIGNvbnN0IGRhdGEgPSBuZXcgRmxvYXQzMkFycmF5KGFycmF5QnVmZmVyLnNsaWNlKGRhdGFTdGFydCwgZGF0YUVuZCkpO1xuICAgICAgLy8gcmVzdCBvZiBwYXlsb2FkXG4gICAgICBjb25zdCBtZXRhU3RhcnQgPSBkYXRhRW5kO1xuICAgICAgY29uc3QgbWV0YUJ1ZmZlciA9IG5ldyBVaW50MTZBcnJheShhcnJheUJ1ZmZlci5zbGljZShtZXRhU3RhcnQpKTtcbiAgICAgIGNvbnN0IG1ldGFkYXRhID0gVWludDE2QXJyYXkyanNvbihtZXRhQnVmZmVyKTtcblxuICAgICAgcmV0dXJuIHsgdGltZSwgZGF0YSwgbWV0YWRhdGEgfTtcbiAgfVxufVxuIl19